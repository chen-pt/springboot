function initUser(){require(["permission"],function(e){e.User.getList(1),$(document).on("click","#user-search-btn",function(){e.User.getList(1)})})}function initRole(){var e,t;require(["permission"],function(s){t=s,t.Role.getList(1),e=t.Role}),$(document).on("click","#role-search-btn",function(){t.Role.getList(1)}),$(document).on("click","#add-role-btn,.edit-role",function(){if($(this).parents("tr").size())var t=$(this).parents("tr").data("tree").datas;else t={};var s=doT.template($("#add-role-temp").html())(t);$.alert({backdrop:"static",width:"small",title:"添加/编辑角色",hasfoot:!0,okBtn:"添加",cancelBtn:"取消",body:s,okHide:function(){var t=$("#edit-role-form").serializeArray(),s=this;return $("#role-name").val().trim()?(e.edit(t).done(function(t){t.status?(alert("操作成功"),s.$element.modal("hide"),e.getList(1)):alert(t.result.msg)}),!1):void layer.msg("角色名称不能为空")}})}),$(document).on("click",".set-permission",function(){var s=$(this).parents("tr").data("tree").datas,n=t.getPermissionList(),i=t.getPermissionTypeList();$.when(n,i).done(function(t,n){var i=t[0],o=n[0];if(i.status&&i.result.items.length&&o.status&&o.result.items.length){i=i.result.items,o=o.result.items,$(i).each(function(e,t){$(o).each(function(e,s){t.type_id==s.id&&(o[e].permissions?o[e].permissions.push(t):o[e].permissions=[t])})});var a=doT.template($("#set-permission-temp").html())({record:s,module:o}),r=$.alert({backdrop:"static",width:"normal",title:"设置权限",hasfoot:!1,body:a});$(s.permissions).each(function(e,t){$('[value="'+t+'"]').click()}),r.on("click","#save-permission-btn",function(){var t=$("#set-permission-form").serializeArray();e.edit(t).done(function(t){t.status?(alert("操作成功"),r.modal("hide"),e.getList(1)):alert(t.result.msg)})})}else alert("获取权限失败")}).fail(function(){alert("获取权限失败!")})}),$(document).on("click",".permission-group-label",function(){var e=$(this).find("input");$("#permission-group-"+e.val()).find("input:checkbox").prop("checked",e[0].checked)}),$(document).on("click",".permission-label",function(){var e=$(this).parents("td");e.find("input").size()==e.find("input:checked").size()?$(this).parents("td").siblings("td").find(".permission-group-label input").prop("checked",!0):$(this).parents("td").siblings("td").find(".permission-group-label input").prop("checked",!1)}),$(document).on("click",".set-user",function(){var s=$(this).parents("tr").data("tree").datas;t.getStoreAdminList().done(function(t){if(!t.status)return layer.msg("获取用户列表失败!"),!1;var n=doT.template($("#set-user-temp").html())({record:s,userList:t.result.items}),i=$.alert({backdrop:"static",width:"normal",title:"设置用户",hasfoot:!1,body:n});$(s.managers).each(function(e,t){$('[value="'+t.manager_id+'"]').click()}),i.on("click","#save-user-btn",function(){var t=$("#set-user-form").serializeArray();e.setUser(t).done(function(t){t.status?(alert("操作成功"),i.modal("hide"),e.getList(1)):alert(t.result.msg)})})}).fail(function(){alert("当前网络似乎有点问题",{icon:8})})}),$(document).on("click",".del-role",function(){var t=$(this).parents("tr").data("tree").datas.id;confirm("您确定删除该角色吗？提示：该角色内的所有权限和用户将同时被移除。")&&e.drop(t).done(function(t){alert(t.result.msg||"删除失败"),t.status&&e.getList(1)})})}function initEditUser(){$(function(){$("#edit-user-form").validate({success:function(e){var t=e.serializeArray();return $.ajax({url:e[0].action,data:t,type:"post",dataType:"json"}).done(function(e){layer.msg(e.result.msg,{time:3e3},function(){e.status&&(location.pathname="/user/list")})}),!1}})})}function initLog(){require(["permission"],function(e){function t(t){t=t||1,e.getLogList(t)}t(1),$(document).on("click","#log-search-btn",function(){t(1)})})}function initAuthCode(){require(["permission"],function(e){$(function(){$("#auth-code-form").validate({success:function(t){e.setAuthCode(t.serializeArray()).done(function(e){e.status&&t[0].reset()})}})})})}define("core",[],function(){function submitPwd(e){$.ajax({type:"POST",data:e,url:getHost()+"/member/updatePwd",success:function(e){var t=JSON.parse(e);console.log(t),t.status?(layer.msg("密码修改成功！"),$("#pwd-modal").modal("hide")):layer.msg("密码修改失败！")}})}var doTinit=function(){doT.templateSettings={evaluate:/\[\%([\s\S]+?)\%\]/g,interpolate:/\[\%=([\s\S]+?)\%\]/g,encode:/\[\%!([\s\S]+?)\%\]/g,use:/\[\%#([\s\S]+?)\%\]/g,define:/\[\%##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\%\]/g,conditional:/\[\%\?(\?)?\s*([\s\S]*?)\s*\%\]/g,iterate:/\[\%~\s*(?:\%\]|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\%\])/g,varname:"it",strip:!0,append:!0,selfcontained:!1}},getHost=function(){var e=location.origin||location.protocol+"//"+location.hostname+(80==location.port?"":":"+location.port);return e},exeError=function(e,t,s,n){if("http"==e.type){var i="status:"+t.status+" state:"+t.readyState+" text:"+s+" err:"+JSON.stringify(n);e.desc=i}console.log("错误处理："+JSON.stringify(e))},formatDate=function(){Date.prototype.format=function(e){e||(e="yyyy-MM-dd hh:mm:ss");var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var s in t)new RegExp("("+s+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[s]:("00"+t[s]).substr((""+t[s]).length)));return e}},ReConsole=function(){window.console=window.console||function(){var e={};return e.log=e.warn=e.debug=e.info=e.error=e.time=e.dir=e.profile=e.clear=e.exception=e.trace=e.assert=function(){},e}()},isExitsFunction=function(funcName){try{if("function"==typeof eval(funcName))return!0}catch(e){}return!1},isExitsVariable=function(e){try{return"undefined"!=typeof e}catch(t){}return!1};return $(document).on("click","#branner .download",function(){try{localStorage.setItem("is_show",!0)}catch(e){}}),$(document).on("click","#upgrade-bar .sui-close",function(){try{localStorage.setItem("upgrade-version",CURRENT_VERSION)}catch(e){}}),$(document).on("shown","#pwd-modal",function(){$("#pwd-form").validate({success:function(e){var t=e.serializeArray();submitPwd(t)}})}),$(document).on("hidden","#pwd-modal",function(){$("#pwd-form")[0].reset()}),$(function(){$.ajax({type:"get",url:getHost()+"/helpful/upgrade",dataType:"json"}).done(function(e){return e.status&&e.result.items.length?($("#upgrade-bar").find(".upgrade-title").empty().append(e.result.items[0].title).end().show(),$("#upgrade").find(".upgrade-content").empty().append(e.result.items[0].content),void(200==e.result.items[0].tips_type&&$("#upgrade-bar").hide())):null})}),$(function(){$.ajax({type:"POST",url:getHost()+"/store/getGrcode",success:function(e){1!=e&&$("#grcode").attr("src",e)},error:function(e,t){console.log("status:"+e.status),console.log("state:"+e.readyState),console.log("text:"+t)}})}),{doTinit:doTinit,getHost:getHost,exeError:exeError,formatDate:formatDate,ReConsole:ReConsole,isExitsVariable:isExitsVariable,isExitsFunction:isExitsFunction}}),define("service/pagin",[],function(){return $.fn.pagination.Constructor.prototype=$.extend($.fn.pagination.Constructor.prototype,{_drawCtrl:function(){var e="";if(this.pageSize&&this.itemsCount){var t=$('<select class="page-size-sel"></select>'),s=[15,30,50,100];for(var n in s){var i='<option value="'+s[n]+'"'+(this.pageSize==s[n]?"selected":"")+">"+s[n]+"</option>";t.append(i)}e+=t.prop("outerHTML"),e+="<div>&nbsp;"+("itemsCount"==this.displayInfoType?"<span>共"+this.itemsCount+"条</span>&nbsp;":"<span>共"+this.pages+"页</span>&nbsp;")+"("+this.itemsCount+'条记录)<span>&nbsp;到&nbsp;<input type="text" class="page-num"/><button class="page-confirm">确定</button>&nbsp;页</span></div>'}else e="<div>&nbsp;"+("itemsCount"==this.displayInfoType?"<span>共"+this.itemsCount+"条</span>&nbsp;":"<span>共"+this.pages+"页</span>&nbsp;")+'<span>&nbsp;到&nbsp;<input type="text" class="page-num"/><button class="page-confirm">确定</button>&nbsp;页</span></div>';return e},updateConfig:function(e){e.pageSize&&(this.pageSize=e.pageSize)}}),function(e,t,s,n,i,o,a){if(t=t||1,s=s||1,s||(s=Math.ceil(i/n)),"object"!=typeof e)var r=$(e);else r=e;r.data("sui-pagination",""),r.pagination({pages:s,styleClass:["pagination-large","pagination-right"],showCtrl:!0,displayPage:6,pageSize:n,itemsCount:i,currentPage:t,onSelect:o}),r.pagination("updatePages",~~s,~~t),r.data("evt-init")||(r.on("change",".page-size-sel",function(){r.pagination("updateConfig",{pageSize:+this.value}),o(1)}),r.data("evt-init",1))}}),define("permission",["core","service/pagin"],function(e,t){function s(t){return t=t||{pageno:1,pagesize:100,"permission-platform":110},$.ajax({url:e.getHost()+"/permission/getPermissionList",data:t,type:"post",dataType:"json"})}function n(){return $.ajax({url:e.getHost()+"/permission/getPermissionTypeList",type:"post",dataType:"json"})}function i(t){return t=t||{pageno:1,pagesize:1e3},$.ajax({url:e.getHost()+"/permission/getStoreAdminList",data:t,type:"post",dataType:"json"})}function o(s){s=s||1;var n=$("#search-log-form").serializeArray(),i=$(".page-size-sel").val()||15;n.push({name:"pageno",value:s}),n.push({name:"pagesize",value:i});var a=layer.load(1,{shade:[.1,"#fff"]}),r=new Date;$.ajax({url:e.getHost()+"/permission/getlogsList",data:n,type:"post",dataType:"json"}).done(function(e){new Date-r<1500?setTimeout(function(){layer.close(a)},1500-(new Date-r)):layer.close(a);var s=$("#log-row-temp").html();s=doT.template(s)(e),$("#log-list").empty().append(s),e.status?(t("#log-pagin",+e.result.current,e.result.total_pages,i,e.result.total_items,function(e){o(e)}),$("#log-pagin").show()):$("#log-pagin").hide()})}function a(t){return $.ajax({url:e.getHost()+"/permission/setAuthCode",type:"post",data:t,dataType:"json"}).done(function(e){e.status?layer.alert("设置成功"):layer.alert(e.result.msg)})}function r(){return $.ajax({url:e.getHost()+"/permission/setAuthCode",type:"post",data:data,dataType:"json"}).done(function(e){e.status?layer.alert("设置成功"):layer.alert(e.result.msg)})}var u={},l={};return u.getList=function(e){e=e||1;var s=$("#search-user-form").serializeArray(),n=$(".page-size-sel").val()||15;s.push({name:"pageno",value:e}),s.push({name:"pagesize",value:n});var o=layer.load(1,{shade:[.1,"#fff"]}),a=new Date;i(s).done(function(e){new Date-a<1500?setTimeout(function(){layer.close(o)},1500-(new Date-a)):layer.close(o);var s=doT.template($("#user-row-temp").html())(e),i=$("#user-list");i.empty().append(s),e.status&&e.result.items&&$(e.result.items).each(function(e){i.find("tr").eq(e).data("tree",{datas:this})}),e.status&&e.result.items.length?(t("#user-pagin",+e.result.current,e.result.total_pages,n,e.result.total_items,function(e){u.getList(e)}),$("#user-pagin").show()):$("#user-pagin").hide()})},l.getList=function(s){s=s||1;var n=$("#search-role-form").serializeArray(),i=$(".page-size-sel").val()||15;n.push({name:"pageno",value:s}),n.push({name:"pagesize",value:i});var o=layer.load(1,{shade:[.1,"#fff"]}),a=new Date;$.ajax({url:e.getHost()+"/permission/getRoleList",data:n,type:"post",dataType:"json"}).done(function(e){new Date-a<1500?setTimeout(function(){layer.close(o)},1500-(new Date-a)):layer.close(o);var s=doT.template($("#role-row-temp").html())(e),n=$("#role-list");n.empty().append(s),e.status&&e.result.items&&$(e.result.items).each(function(e){n.find("tr").eq(e).data("tree",{datas:this})}),e.status&&e.result.items.length?(t("#role-pagin",+e.result.current,e.result.total_pages,i,e.result.total_items,function(e){l.getList(e)}),$("#role-pagin").show()):$("#role-pagin").hide()})},l.edit=function(t){return $.ajax({url:e.getHost()+"/role/editRole",data:t,type:"post",dataType:"json"})},l.drop=function(t){return $.ajax({url:e.getHost()+"/role/dropRole",data:{role_id:t},type:"post",dataType:"json"})},l.setUser=function(t){return $.ajax({url:e.getHost()+"/role/storeRoleManagers",data:t,type:"post",dataType:"json"})},{User:u,Role:l,getPermissionList:s,getPermissionTypeList:n,getStoreAdminList:i,getLogList:o,setAuthCode:a,showGetStorePower:r}}),require.config({paths:{core:"../lovejs/core",tools:"../lovejs/tools",permission:"service/permission"}}),$(function(){require(["core"],function(e){e.doTinit(),e.ReConsole()});var e=window.location.pathname;switch(e){case"/permission/index":initUser();break;case"/permission/role":initRole();break;case"/permission/editUser":initEditUser();break;case"/permission/perationLog":initLog();break;case"/permission/authcode":initAuthCode()}}),define("permission_index",function(){});
function initNew(){function addCondition(t,e){var o=t.find(".full-cut-condition").size();if(o>=9){if(!$(this).hasClass("disabled")){$(this).addClass("disabled");var n=$("#"+e).html();n=doT.template(n)({index:o+1}),t.append(n),t.find(".last").removeClass("last").end().find(".full-cut-condition:eq(-1)").addClass("last")}}else n=$("#"+e).html(),n=doT.template(n)({index:o+1}),t.append(n),t.find(".last").removeClass("last").end().find(".full-cut-condition:eq(-1)").addClass("last")}function selGoodsPage(t,e){location.hash="#all-goods",$("#formId").val(e),$("#back").attr("href","#"+$("#"+e).parent(".tab-pane").attr("id"))}function addShop(t){try{var e=$("#sel-ids"),o=e.val();t=o+","+t,t=$(t.split(",")).filter(function(t,e){return e}).get(),t=$.unique(t),e.val(t.join()),$("#sel-goods-num").empty().append(t.length)}catch(n){return!1}return!0}function rmShop(t){$.isArray(t)||(t=(t+"").split(","));try{var e=$("#sel-ids"),o=e.val().split(",");for(var n in t){var i=o.indexOf(t[n]);-1!=i&&o.splice(i,1)}e.val(o.join()),$("#sel-goods-num").empty().append(o.length)}catch(a){return!1}return!0}$(document).on("click","#add-mj-condition",function(){var t=$("#mj-conditions");addCondition.call(this,t,"mj-condition-temp"),$(".autoNumberic").autoNumeric("init",{aSep:"",mDec:2})}),$(document).on("click",".del-mj-condition",function(){$(this).parents(".full-cut-condition").fadeOut("fast",function(){$(this).remove(),$("#mj-conditions").find(".full-cut-condition:visible:eq(-1)").addClass("last")})}),$(document).on("click","#add-first-condition",function(){var t=$("#first-conditions");addCondition.call(this,t,"first-condition-temp"),$(".autoNumberic").autoNumeric("init",{aSep:"",mDec:2})}),$(document).on("click",".del-first-condition",function(){$(this).parents(".full-cut-condition").fadeOut("fast",function(){$(this).remove(),$("#first-conditions").find(".full-cut-condition:visible:eq(-1)").addClass("last")})}),$(document).on("click",".select_all_city",function(){$("#free_ragion_list").find("input:checkbox").prop("checked",!0)}),$(document).on("click",".unselect_all_city",function(){$("#free_ragion_list").find("input:checkbox").each(function(){this.checked=!this.checked})}),$(document).on("click",".city-group",function(){var t=$(this).find("input").prop("name"),e=$(this).find("input").prop("checked");$("[name="+t+"]").prop("checked",e)}),$(document).on("click",".select_city_ok",function(){var t=[],e=$("#free_ragion_list").find("input:checkbox:checked").map(function(){return 0!=this.value?(t.push($(this).parent().text().trim()),this.value):void 0}).get().join(",");$("#exclude-city-names").empty().append(t.join(",")),$("#exclude-city-ids").val(e)}),$(document).on("change","[name=promotion_goods_range]",function(){2==this.value?$(this).parents("form").find("input:submit").val("下一步，选择参与商品"):3==this.value?$(this).parents("form").find("input:submit").val("下一步，选择不参与商品"):$(this).parents("form").find("input:submit").val("确定")}),$(document).on("click","#check-all-goods",function(){var t=this.checked;$("[name=add-goods]").prop("checked",t)}),$(document).on("click","#check-sel-goods",function(){var t=this.checked;$("[name=rm-goods]").prop("checked",t)}),$(document).on("change","[name=add-goods]",function(){$("[name=add-goods]:checked").size()==$("[name=add-goods]").size()?$("#check-all-goods").prop("checked",!0):$("#check-all-goods").prop("checked",!1)}),$(document).on("change","#sel-goods-list [name=rm-goods]",function(){var t=$("#sel-goods-list");t.find("[name=rm-goods]:checked").size()==t.find("[name=rm-goods]").size()?$("#check-sel-goods").prop("checked",!0):$("#check-sel-goods").prop("checked",!1)}),$(document).on("click","#batch-add-btn",function(){var t=$("[name=add-goods]:checked").map(function(){return this.value}).get();return t.length?void(addShop(t)?(layer.msg("添加成功"),$("#all-goods-list").trigger("data:refresh")):layer.msg("添加失败")):void layer.msg("请选择商品")}),$(document).on("click","#batch-rm-btn",function(){var t=$("#sel-goods-list").find("[name=rm-goods]:checked"),e=t.map(function(){return this.value}).get();return e.length?void(rmShop(e)?(layer.msg("移出成功"),t.parents("tbody").trigger("data:refresh")):layer.msg("添加失败")):void layer.msg("请选择商品")}),$(document).on("click",".add-shop",function(){addShop($(this).data("id"))?(layer.msg("添加成功"),$("#all-goods-list").trigger("data:refresh")):layer.msg("添加失败")}),$(document).on("click",".rm-shop",function(){rmShop($(this).data("id"))?(layer.msg("移出成功"),$(this).parents("tbody").trigger("data:refresh")):layer.msg("添加失败")}),$(window).on("hashchange",function(){var t=location.hash.replace("#",""),e=["full_reduce","free_post","discount","first_order","limited_price"],o=["all-goods","sel-goods"];switch(-1!=$.inArray(t,e)?($("#activity-page").show(),$("#set-goods-page").hide()):-1!=$.inArray(t,o)&&($("#set-goods-page").show(),$("#activity-page").hide()),t){case"full_reduce":$("[href=#full_reduce]").tab("show");break;case"free_post":$("[href=#free_post]").tab("show");break;case"discount":$("[href=#discount]").tab("show");break;case"first_order":$("[href=#first_order]").tab("show");break;case"limited_price":$("[href=#limited_price]").tab("show");break;case"all-goods":$("[href=#all-goods]").tab("show");break;case"sel-goods":$("[href=#sel-goods]").tab("show")}}),require(["promotion"],function(promotion){promotion.init(),$(document).on("show","#goods-nav",function(t){var e=$("#formId").val();if(!e)return void(location.hash="#full_reduce");var o=$("#"+e).find("[name=promotion_type]").val();switch(160==o?($(".discount-price-head").hide(),$(".litmit-price-head").show()):($(".litmit-price-head").hide(),$(".discount-price-head").show()),t.target.hash){case"#all-goods":promotion.getGoodsList(1);break;case"#sel-goods":promotion.getSelGoodsList(1)}}),$(document).on("submit","#goods-search-form",function(){promotion.getGoodsList(1)}),$(document).on("data:refresh","#all-goods-list",function(){promotion.getGoodsList()}),$(document).on("data:refresh","#sel-goods-list",function(){promotion.getSelGoodsList()}),promotion.tools(120).getCitys(),$("#full_reduce_form, #free_post_form, #discount-form, #first_order_form, #limited_post_form").validate({success:function($form){var data=$form.serializeArray(),type=$form.find("[name=promotion_type]").val(),t="";if(130==type||140==type){var flag=!0,promotion_info=[];$form.find(".full-cut-condition input:text").each(function(k){var o={meet_price:"",discount_price:""},meet_price="meet_price",discount_price="discount_price";k%2==0&&(promotion_info[k/2]=o),eval(this.name+"="+(this.value||0))});for(var i in promotion_info)flag&=promotion_info[i].discount_price<promotion_info[i].meet_price,flag&&i>0&&(flag&=promotion_info[i].meet_price>promotion_info[i-1].meet_price);if(!flag)return $form.find(".condition-tips").show(),!1}var goods_range=$form.find("[name=promotion_goods_range]").val();2==goods_range?selGoodsPage(2,$form.prop("id")):3==goods_range?selGoodsPage(3,$form.prop("id")):promotion.tools(type).send(data)}}),$(document).on("click","#save-activity",function(){var t=$("#"+$("#formId").val()),e=t.serializeArray(),o=$("#sel-ids").val();return o?(e.push({name:"promotion_goods",value:o}),void promotion.tools(110).send(e)):void(2==t.find("[name=promotion_goods_range]").val()?layer.alert("请选择参与活动的商品"):layer.alert("请选择不参与活动的商品"))}),$(function(){location.hash=location.hash||$("#activity-nav").find(".active a").prop("hash")||"full_reduce",$(window).trigger("hashchange")})}),$(function(){$(".autoNumberic").autoNumeric("init",{aSep:"",mDec:2}),$.validate.setRule("gtdate",function(t,e,o){var n=$("#"+o).val().replace(/-/g,"/");return new Date(t.replace(/-/g,"/"))>new Date(n)},function(t,e){return"必须大于"+e}),$.validate.setRule("minnumber",function(t,e,o){return parseFloat(t)>=parseFloat(o)},function(t,e){return"不能小于"+e}),$.validate.setRule("maxnumber",function(t,e,o){return parseFloat(t)<=parseFloat(o)},function(t,e){return"不能大于"+e})})}function initList(){require(["promotion"],function(t){$(document).on("click",".kill-ac",function(){var e=$(this).data("a-id");layer.confirm("你确定结束这个活动吗?",function(){t.endPromotion(e)})}),$(document).on("submit","#search-form",function(){t.getList(1)}),t.getList(1)})}function initCat(){$(function(){var t=$("#activity-nav").find(".active a").prop("hash");$(t).find("input").prop("disabled",!0),$(t).find("select").prop("disabled",!0),$(t).find("textarea").prop("disabled",!0)}),require(["promotion","service/pagin"],function(t,e){function o(n){t.getSelGoodsList(n).done(function(t){var n=$("#cat-goods-temp").html();n=doT.template(n)(t),$("#cat-goods-list").empty().append(n),e("#cat-goods-pagin",t.result.current||1,t.result.total_pages||1,null,null,o,["pagination-small","pagination-right"])})}$(document).on("show","#cat-goods",function(){o(1)})})}define("core",[],function(){function submitPwd(t){$.ajax({type:"POST",data:t,url:getHost()+"/member/updatePwd",success:function(t){var e=JSON.parse(t);console.log(e),e.status?(layer.msg("密码修改成功！"),$("#pwd-modal").modal("hide")):layer.msg("密码修改失败！")}})}var doTinit=function(){doT.templateSettings={evaluate:/\[\%([\s\S]+?)\%\]/g,interpolate:/\[\%=([\s\S]+?)\%\]/g,encode:/\[\%!([\s\S]+?)\%\]/g,use:/\[\%#([\s\S]+?)\%\]/g,define:/\[\%##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\%\]/g,conditional:/\[\%\?(\?)?\s*([\s\S]*?)\s*\%\]/g,iterate:/\[\%~\s*(?:\%\]|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\%\])/g,varname:"it",strip:!0,append:!0,selfcontained:!1}},getHost=function(){var t=location.origin||location.protocol+"//"+location.hostname+(80==location.port?"":":"+location.port);return t},exeError=function(t,e,o,n){if("http"==t.type){var i="status:"+e.status+" state:"+e.readyState+" text:"+o+" err:"+JSON.stringify(n);t.desc=i}console.log("错误处理："+JSON.stringify(t))},formatDate=function(){Date.prototype.format=function(t){t||(t="yyyy-MM-dd hh:mm:ss");var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var o in e)new RegExp("("+o+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?e[o]:("00"+e[o]).substr((""+e[o]).length)));return t}},ReConsole=function(){window.console=window.console||function(){var t={};return t.log=t.warn=t.debug=t.info=t.error=t.time=t.dir=t.profile=t.clear=t.exception=t.trace=t.assert=function(){},t}()},isExitsFunction=function(funcName){try{if("function"==typeof eval(funcName))return!0}catch(e){}return!1},isExitsVariable=function(t){try{return"undefined"!=typeof t}catch(e){}return!1};return $(document).on("click","#branner .download",function(){try{localStorage.setItem("is_show",!0)}catch(t){}}),$(document).on("click","#upgrade-bar .sui-close",function(){try{localStorage.setItem("upgrade-version",CURRENT_VERSION)}catch(t){}}),$(document).on("shown","#pwd-modal",function(){$("#pwd-form").validate({success:function(t){var e=t.serializeArray();submitPwd(e)}})}),$(document).on("hidden","#pwd-modal",function(){$("#pwd-form")[0].reset()}),$(function(){$.ajax({type:"get",url:getHost()+"/helpful/upgrade",dataType:"json"}).done(function(t){return t.status&&t.result.items.length?($("#upgrade-bar").find(".upgrade-title").empty().append(t.result.items[0].title).end().show(),$("#upgrade").find(".upgrade-content").empty().append(t.result.items[0].content),void(200==t.result.items[0].tips_type&&$("#upgrade-bar").hide())):null})}),$(function(){$.ajax({type:"POST",url:getHost()+"/store/getGrcode",success:function(t){1!=t&&$("#grcode").attr("src",t)},error:function(t,e){console.log("status:"+t.status),console.log("state:"+t.readyState),console.log("text:"+e)}})}),{doTinit:doTinit,getHost:getHost,exeError:exeError,formatDate:formatDate,ReConsole:ReConsole,isExitsVariable:isExitsVariable,isExitsFunction:isExitsFunction}}),define("service/pagin",[],function(){return $.fn.pagination.Constructor.prototype=$.extend($.fn.pagination.Constructor.prototype,{_drawCtrl:function(){var t="";if(this.pageSize&&this.itemsCount){var e=$('<select class="page-size-sel"></select>'),o=[15,30,50,100];for(var n in o){var i='<option value="'+o[n]+'"'+(this.pageSize==o[n]?"selected":"")+">"+o[n]+"</option>";e.append(i)}t+=e.prop("outerHTML"),t+="<div>&nbsp;"+("itemsCount"==this.displayInfoType?"<span>共"+this.itemsCount+"条</span>&nbsp;":"<span>共"+this.pages+"页</span>&nbsp;")+"("+this.itemsCount+'条记录)<span>&nbsp;到&nbsp;<input type="text" class="page-num"/><button class="page-confirm">确定</button>&nbsp;页</span></div>'}else t="<div>&nbsp;"+("itemsCount"==this.displayInfoType?"<span>共"+this.itemsCount+"条</span>&nbsp;":"<span>共"+this.pages+"页</span>&nbsp;")+'<span>&nbsp;到&nbsp;<input type="text" class="page-num"/><button class="page-confirm">确定</button>&nbsp;页</span></div>';return t},updateConfig:function(t){t.pageSize&&(this.pageSize=t.pageSize)}}),function(t,e,o,n,i,a,s){if(e=e||1,o=o||1,o||(o=Math.ceil(i/n)),"object"!=typeof t)var r=$(t);else r=t;r.data("sui-pagination",""),r.pagination({pages:o,styleClass:["pagination-large","pagination-right"],showCtrl:!0,displayPage:6,pageSize:n,itemsCount:i,currentPage:e,onSelect:a}),r.pagination("updatePages",~~o,~~e),r.data("evt-init")||(r.on("change",".page-size-sel",function(){r.pagination("updateConfig",{pageSize:+this.value}),a(1)}),r.data("evt-init",1))}}),define("promotion",["core","service/pagin"],function(t,e){function o(){}function n(){}function i(){}function a(){}function s(){}var r={};return r.tools=function(t){switch(t){case 110:return new i;case 120:return new n;case 130:return new o;case 140:return new a;case 160:return new s;default:return new i}},r.add=function(){},r.init=function(t){},r.getList=function(o){var n=$("#search-form").serializeArray(),i=$(".page-size-sel").val()||15;n.push({name:"pageno",value:o}),n.push({name:"pagesize",value:i});var a=layer.load(1,{shade:[.1,"#fff"]}),s=new Date;$.ajax({url:t.getHost()+"/promotion/getList",type:"post",data:n,dataType:"json"}).done(function(t){new Date-s<1500?setTimeout(function(){layer.close(a)},1500-(new Date-s)):layer.close(a);var o=$("#promotion-list-temp").html();o=doT.template(o)(t),$("#promotion-list").empty().append(o),e("#pagin",+t.result.current,t.result.total_pages||1,i,t.result.total_items,function(t){r.getList(t)})})},r.getGoodsList=function(o){o=o||$("#all-goods-pagin").find(".active a").attr("data")||1;var n=$("#goods-search-form").serializeArray();n.push({name:"pageno",value:o});var i=$(".page-size-sel").val()||15;n.push({name:"pagesize",value:i}),$.ajax({url:t.getHost()+"/goods/getList",type:"post",data:n,dataType:"json"}).done(function(t){var o=$("#goods-list-temp").html();t.type=$("#"+$("#formId").val()).find("[name=promotion_type]").val(),160==t.type?t.limit_price=$("#limit_price").val():t.discount=$("#dis").val(),t.selIds=$("#sel-ids").val().split(","),o=doT.template(o)(t),$("#all-goods-list").empty().append(o),e("#all-goods-pagin",+t.result.current,t.result.total_pages||1,i,t.result.total_items,function(t){r.getGoodsList(t)}),$("#check-all-goods").prop("checked",!1)})},r.getSelGoodsList=function(o){o=o||$("#sel-goods-pagin").find(".active a").attr("data")||1;var n=$("#sel-ids").val().split(","),i=10,a=(o-1)*i,s=n.slice(a,a+i).join();return s||1==o||(o--,a=(o-1)*i,s=n.slice(a,a+i).join()),$.ajax({url:t.getHost()+"/goods/batchList",type:"post",data:{goods_ids:s},dataType:"json"}).done(function(t){t.status&&(t.result={items:t.result},t.result.current=o,t.result.total_pages=Math.ceil(n.length/i)||1),t.type=$("#"+$("#formId").val()).find("[name=promotion_type]").val(),160==t.type?t.limit_price=$("#limit_price").val():t.discount=$("#dis").val(),t.selIds=$("#sel-ids").val().split(",");var a=$("#goods-list-temp").html();a=doT.template(a)(t),$("#sel-goods-list").empty().append(a),e("#sel-goods-pagin",+t.result.current,t.result.total_pages||1,i,t.result.total_items,function(t){r.getSelGoodsList(t)}),$("#check-sel-goods").prop("checked",!1)})},r.send=function(e){$.ajax({url:t.getHost()+"/promotion/send",type:"post",data:e,dataType:"json"}).done(function(t){t.status?layer.alert('活动创建成功,点此<a href="/promotion/index">返回列表</a>'):t.result.notes?layer.alert("活动有效期内已有同类型的活动。"):layer.alert(t.result.msg)})},r.endPromotion=function(e){$.ajax({url:t.getHost()+"/promotion/endPromotion",type:"post",data:{promotion_id:e},dataType:"json"}).done(function(t){t.status?(layer.msg("结束成功"),r.getList(1)):layer.msg(t.result.msg)})},o.prototype=r,n.prototype=r,n.prototype.getCitys=function(){return $.ajax({url:t.getHost()+"/lib/getcitys_ext",type:"post",dataType:"json"}).done(function(t){var e=$("#free_ragion_list").empty();for(var o in t.result){var n=t.result[o].code,i='<div class="control-group" style="width: 100%;margin-bottom: 8px;"><label style="font-weight: bold;width: 50px;display: table-cell;vertical-align: top;" class="city-group"><input type="checkbox" value="0" name="'+n+'">'+t.result[o].name+'</label><div class="controls">';for(var a in t.result[o].provinces){var s=t.result[o].provinces[a];i+='<label style="width: 20%;float: left;display: block;margin-bottom: 8px;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;"><input type="checkbox" name="'+n+'" value="'+s.areaid+'">'+s.name+"</label>"}i+="</div></div>",e.append(i)}})},i.prototype=r,a.prototype=r,s.prototype=r,r}),require.config({paths:{core:"../lovejs/core",tools:"../lovejs/tools",promotion:"service/promotion"}}),$(function(){require(["core"],function(t){t.doTinit(),t.ReConsole()});var t=window.location.pathname;switch(t){case"/promotion/new":initNew();break;case"/promotion/modify":initNew();break;case"/promotion/cat":initCat();break;case"/promotion/index":initList()}$(document).on("input",".input-wrap input, .input-wrap textarea",function(){var t=$(this).parent(".input-wrap"),e=~~t.find(".max-length").html(),o=t.find(".num-limit");o.empty().append(this.value.length),this.value.length>e?o.addClass("red"):o.removeClass("red")}),$(document).on("click",".sui-dropdown-menu a",function(){var t=$(this),e=t.parent(),o=t.parents(".sui-dropdown, .sui-dropup"),n=o.find("[role='menu']");e.is(".disabled, :disabled")||o.is(".disabled, :disabled")||(o.find("input").val(t.attr("value")||"").trigger("change"),o.find("[data-toggle=dropdown] span").html(t.text()),n.find(".active").removeClass("active"),e.addClass("active"))})}),define("promotion_index",function(){});